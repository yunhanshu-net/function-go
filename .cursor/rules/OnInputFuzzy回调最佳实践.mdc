---
description: OnInputFuzzyå›è°ƒçš„æœ€ä½³å®è·µå’Œä¼˜åŒ–ç‰ˆæœ¬ï¼ŒåŒ…å«ä¸‰å±‚æŸ¥è¯¢é€»è¾‘å’Œæ€§èƒ½ä¼˜åŒ–
globs:
alwaysApply: true
---

# OnInputFuzzyå›è°ƒæœ€ä½³å®è·µ

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

### 1. ä¸‰å±‚æŸ¥è¯¢é€»è¾‘ï¼ˆæ¨èä½¿ç”¨ï¼‰

åŸºäºæœ€æ–°å®è·µï¼ŒOnInputFuzzyå›è°ƒåº”è¯¥ä½¿ç”¨ä»¥ä¸‹ä¸‰å±‚æŸ¥è¯¢é€»è¾‘ï¼š

```go
OnInputFuzzyMap: map[string]runner.OnInputFuzzy{
    "field_name": func(ctx *runner.Context, req *usercall.OnInputFuzzyReq) (*usercall.OnInputFuzzyResp, error) {
        // ã€å½“å‰åœºæ™¯ã€‘è¯´æ˜å­—æ®µç±»å‹å’Œæ˜¯å¦æ”¯æŒèšåˆ
        // ã€ç›®æ ‡å­—æ®µã€‘æ˜ç¡®è¯´æ˜ä¸ºå“ªä¸ªè¯·æ±‚ç»“æ„ä½“çš„å“ªä¸ªå­—æ®µæä¾›æ•°æ®
        var items []YourModel
        db := ctx.MustGetOrInitDB()

        if req.IsByFiledValues() {
            // å¤šå€¼æŸ¥è¯¢ï¼šä½¿ç”¨ IN æŸ¥è¯¢ï¼Œè¿™é‡Œå¿…é¡»ç”¨ db = db.Where
            db = db.Where("id in ?", req.GetFiledValues())
        } else if req.IsByFiledValue() {
            // å•å€¼æŸ¥è¯¢ï¼šä½¿ç”¨ç­‰å€¼æŸ¥è¯¢ï¼Œæ€§èƒ½æœ€ä¼˜
            db = db.Where("id = ?", req.GetFiledValue()).Limit(1)
        } else {
            // æ¨¡ç³ŠæŸ¥è¯¢ï¼šå…³é”®å­—æœç´¢
            db = db.Where("name LIKE ? OR code LIKE ?", "%"+req.Keyword()+"%", "%"+req.Keyword()+"%").
                Where("status = ?", "æ­£å¸¸").
                Limit(20)
        }
        db.Find(&items) // æœ€åç»Ÿä¸€æ‰§è¡ŒæŸ¥è¯¢

        // æ„å»ºè¿”å›æ•°æ®
        fuzzyItems := make([]*usercall.InputFuzzyItem, 0)
        for _, item := range items {
            fuzzyItems = append(fuzzyItems, &usercall.InputFuzzyItem{
                Value: item.ID,
                Label: fmt.Sprintf("%s - %s", item.Name, item.Description),
                DisplayInfo: map[string]interface{}{
                    "åç§°": item.Name,
                    "æè¿°": item.Description,
                    "çŠ¶æ€": item.Status,
                },
            })
        }

        return &usercall.OnInputFuzzyResp{
            Statistics: map[string]interface{}{
                // æ ¹æ®å­—æ®µç±»å‹å†³å®šæ˜¯å¦ä½¿ç”¨èšåˆè®¡ç®—
                // å•é€‰å­—æ®µï¼šåªè¿”å›é™æ€ä¿¡æ¯
                // å¤šé€‰/Listå­—æ®µï¼šå¯ä»¥ä½¿ç”¨èšåˆè®¡ç®—
            },
            Values: fuzzyItems,
        }, nil
    },
}
```

### 2. æ€§èƒ½ä¼˜åŒ–è¯´æ˜

| æŸ¥è¯¢ç±»å‹ | SQLè¯­å¥ | æ€§èƒ½ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|---------|---------|----------|----------|
| å•å€¼æŸ¥è¯¢ | `id = ?` + `Limit(1)` | æ€§èƒ½æœ€ä¼˜ | å•é€‰å­—æ®µï¼Œç²¾ç¡®åŒ¹é… |
| å¤šå€¼æŸ¥è¯¢ | `id IN ?` | æ‰¹é‡æŸ¥è¯¢ | å¤šé€‰å­—æ®µï¼Œå‡å°‘æŸ¥è¯¢æ¬¡æ•° |
| æ¨¡ç³ŠæŸ¥è¯¢ | `LIKE` + `Limit(20)` | æ§åˆ¶ç»“æœæ•°é‡ | å…³é”®å­—æœç´¢ï¼Œæå‡å“åº”é€Ÿåº¦ |

### 3. æ³¨é‡Šè§„èŒƒ

æ¯ä¸ªå›è°ƒå‡½æ•°éƒ½åº”è¯¥åŒ…å«ï¼š

```go
// ã€å½“å‰åœºæ™¯ã€‘field_nameæ˜¯å•é€‰å­—æ®µï¼Œåªè¿”å›é™æ€ä¿¡æ¯ï¼Œä¸åšèšåˆè®¡ç®—
// ã€ç›®æ ‡å­—æ®µã€‘ä¸º YourRequest.FieldName æä¾›æ•°æ®é€‰æ‹©
```

**æ³¨é‡Šè¯´æ˜**ï¼š
- **ã€å½“å‰åœºæ™¯ã€‘**ï¼šè¯´æ˜å­—æ®µç±»å‹ç‰¹å¾ï¼ˆå•é€‰/å¤šé€‰ï¼Œæ˜¯å¦èšåˆï¼‰
- **ã€ç›®æ ‡å­—æ®µã€‘**ï¼šæ˜ç¡®è¯´æ˜ä¸ºå“ªä¸ªè¯·æ±‚ç»“æ„ä½“çš„å“ªä¸ªå­—æ®µæä¾›æ•°æ®

## ğŸ“ å…·ä½“å®ç°ç¤ºä¾‹

### 1. å•é€‰å­—æ®µï¼ˆä¸èšåˆï¼‰

```go
"doctor_id": func(ctx *runner.Context, req *usercall.OnInputFuzzyReq) (*usercall.OnInputFuzzyResp, error) {
    // ã€å½“å‰åœºæ™¯ã€‘doctor_idæ˜¯å•é€‰å­—æ®µï¼Œåªè¿”å›é™æ€ä¿¡æ¯ï¼Œä¸åšèšåˆè®¡ç®—
    // ã€ç›®æ ‡å­—æ®µã€‘ä¸º HealthcarePrescriptionCreateReq.DoctorID æä¾›åŒ»ç”Ÿé€‰æ‹©æ•°æ®
    var doctors []HealthcareMedicineDoctor
    db := ctx.MustGetOrInitDB()

    if req.IsByFiledValues() {
        // å¤šå€¼æŸ¥è¯¢ï¼šä½¿ç”¨ IN æŸ¥è¯¢ï¼Œè¿™é‡Œå¿…é¡»ç”¨ db = db.Where
        db = db.Where("id in ?", req.GetFiledValues())
    } else if req.IsByFiledValue() {
        // å•å€¼æŸ¥è¯¢ï¼šä½¿ç”¨ç­‰å€¼æŸ¥è¯¢ï¼Œæ€§èƒ½æœ€ä¼˜
        db = db.Where("id = ?", req.GetFiledValue()).Limit(1)
    } else {
        // æ¨¡ç³ŠæŸ¥è¯¢ï¼šå…³é”®å­—æœç´¢
        db = db.Where("name LIKE ? OR title LIKE ? OR department LIKE ?",
            "%"+req.Keyword()+"%", "%"+req.Keyword()+"%", "%"+req.Keyword()+"%").
            Where("status = ?", "åœ¨èŒ").
            Limit(20)
    }
    db.Find(&doctors)

    items := make([]*usercall.InputFuzzyItem, 0)
    for _, d := range doctors {
        items = append(items, &usercall.InputFuzzyItem{
            Value: d.ID,
            Label: fmt.Sprintf("%s - %s (%s)", d.Name, d.Title, d.Department),
            DisplayInfo: map[string]interface{}{
                "åŒ»ç”Ÿå§“å": d.Name,
                "èŒç§°":   d.Title,
                "ç§‘å®¤":   d.Department,
                "è”ç³»ç”µè¯": d.Phone,
            },
        })
    }

    return &usercall.OnInputFuzzyResp{
        Statistics: map[string]interface{}{
            // âœ… å•é€‰åœºæ™¯ï¼šåªè¿”å›æœ‰ç”¨çš„é™æ€ä¿¡æ¯
            "é€‰è¯¾è§„åˆ™": "æ¯å­¦æœŸæœ€å¤šé€‰6é—¨è¯¾ç¨‹",
            "é€€è¯¾æ”¿ç­–": "å¼€è¯¾å‰å¯é€€è¯¾",
            "è¡¥é€‰æ—¶é—´": "æ¯å­¦æœŸç¬¬2å‘¨",
        },
        Values: items,
    }, nil
},
```

### 2. å¤šé€‰å­—æ®µï¼ˆæ”¯æŒèšåˆï¼‰

```go
"product_ids": func(ctx *runner.Context, req *usercall.OnInputFuzzyReq) (*usercall.OnInputFuzzyResp, error) {
    // ã€å½“å‰åœºæ™¯ã€‘product_idsæ˜¯å¤šé€‰å­—æ®µï¼Œæ”¯æŒèšåˆè®¡ç®—
    // ã€ç›®æ ‡å­—æ®µã€‘ä¸º MultiProductReq.ProductIDs æä¾›å•†å“å¤šé€‰æ•°æ®
    var products []Product
    db := ctx.MustGetOrInitDB()

    if req.IsByFiledValues() {
        // å¤šå€¼æŸ¥è¯¢ï¼šä½¿ç”¨ IN æŸ¥è¯¢
        db.Where("id in ?", req.GetFiledValues())
    } else if req.IsByFiledValue() {
        // å•å€¼æŸ¥è¯¢ï¼šä½¿ç”¨ç­‰å€¼æŸ¥è¯¢ï¼Œæ€§èƒ½æœ€ä¼˜
        db.Where("id = ?", req.GetFiledValue()).Limit(1)
    } else {
        // æ¨¡ç³ŠæŸ¥è¯¢ï¼šå…³é”®å­—æœç´¢
        db.Where("name LIKE ? OR code LIKE ?", "%"+req.Keyword()+"%", "%"+req.Keyword()+"%").
            Where("status = ?", "ä¸Šæ¶").
            Limit(20)
    }
    db.Find(&products)

    items := make([]*usercall.InputFuzzyItem, 0)
    for _, p := range products {
        items = append(items, &usercall.InputFuzzyItem{
            Value: p.ID,
            Label: fmt.Sprintf("%s - Â¥%.2f", p.Name, p.Price),
            DisplayInfo: map[string]interface{}{
                "å•†å“åç§°": p.Name,
                "ä»·æ ¼":   p.Price,
                "åº“å­˜":   p.Stock,
            },
        })
    }

    return &usercall.OnInputFuzzyResp{
        Statistics: map[string]interface{}{
            // âœ… å¤šé€‰åœºæ™¯ï¼šæ”¯æŒèšåˆè®¡ç®—
            "é€‰ä¸­å•†å“æ•°": "count(ä»·æ ¼)",           // é€‰äº†å‡ ä¸ªå•†å“
            "é€‰ä¸­å•†å“æ€»ä»·": "sum(ä»·æ ¼,*quantity)", // æ€»ä»·æ ¼
            "æœ€ä½å•ä»·": "min(ä»·æ ¼)",              // é€‰ä¸­å•†å“ä¸­æœ€ä¾¿å®œçš„
            "å¹³å‡å•ä»·": "avg(ä»·æ ¼)",              // é€‰ä¸­å•†å“å¹³å‡ä»·æ ¼
            
            // âœ… é™æ€ä¿¡æ¯
            "ä¼šå‘˜æŠ˜æ‰£": "9æŠ˜ä¼˜æƒ ",
        },
        Values: items,
    }, nil
},
```

### 3. Listå†…å­—æ®µï¼ˆæ”¯æŒèšåˆï¼‰

```go
"product_id": func(ctx *runner.Context, req *usercall.OnInputFuzzyReq) (*usercall.OnInputFuzzyResp, error) {
    // ã€å½“å‰åœºæ™¯ã€‘product_idæ˜¯Listå†…å•é€‰å­—æ®µï¼Œæ”¯æŒèšåˆè®¡ç®—
    // ã€ç›®æ ‡å­—æ®µã€‘ä¸º SimpleCashierDeskReq.ProductQuantities[].ProductID æä¾›å•†å“é€‰æ‹©æ•°æ®
    var products []SimpleCashierProduct
    db := ctx.MustGetOrInitDB()

    if req.IsByFiledValues() {
        // å¤šå€¼æŸ¥è¯¢ï¼šä½¿ç”¨ IN æŸ¥è¯¢
        db.Where("id in ?", req.GetFiledValues())
    } else if req.IsByFiledValue() {
        // å•å€¼æŸ¥è¯¢ï¼šä½¿ç”¨ç­‰å€¼æŸ¥è¯¢ï¼Œæ€§èƒ½æœ€ä¼˜
        db.Where("id = ?", req.GetFiledValue()).Limit(1)
    } else {
        // æ¨¡ç³ŠæŸ¥è¯¢ï¼šå…³é”®å­—æœç´¢
        db.Where("name LIKE ? OR code LIKE ?", "%"+req.Keyword()+"%", "%"+req.Keyword()+"%").
            Where("status = ?", "ä¸Šæ¶").
            Where("stock > ?", 0).
            Limit(20)
    }
    db.Find(&products)

    items := make([]*usercall.InputFuzzyItem, 0)
    for _, p := range products {
        items = append(items, &usercall.InputFuzzyItem{
            Value: p.ID,
            Label: fmt.Sprintf("%s - Â¥%.2f (åº“å­˜:%d)", p.Name, p.Price, p.Stock),
            DisplayInfo: map[string]interface{}{
                "å•†å“åç§°": p.Name,
                "ä»·æ ¼":   p.Price,
                "åº“å­˜":   p.Stock,
            },
        })
    }

    return &usercall.OnInputFuzzyResp{
        Statistics: map[string]interface{}{
            // âœ… Listå†…å­—æ®µï¼šæ”¯æŒèšåˆè®¡ç®—
            "å•†å“åŸä»·(å…ƒ)": "sum(ä»·æ ¼,*quantity)",      // ç”¨æˆ·é€‰æ‹©çš„æ‰€æœ‰å•†å“æ€»ä»·
            "ä¼šå‘˜ä»·æ ¼(å…ƒ)": "sum(ä»·æ ¼,*quantity,*0.9)",  // ä¼šå‘˜9æŠ˜åçš„æ€»ä»·
            "ä¼˜æƒ é‡‘é¢(å…ƒ)": "sum(ä»·æ ¼,*quantity,*0.1)",  // èŠ‚çœçš„é‡‘é¢
            "å•†å“ç§ç±»": "count(ä»·æ ¼)",                  // é€‰äº†å‡ ç§å•†å“
            "å•†å“æ€»æ•°": "sum(quantity)",               // å•†å“æ€»æ•°é‡
            
            // âœ… æœ‰ç”¨çš„é™æ€ä¿¡æ¯
            "ä¼šå‘˜æŠ˜æ‰£": "9æŠ˜ä¼˜æƒ ",
            "é…é€è¯´æ˜": "æ»¡99å…ƒåŒ…é‚®",
        },
        Values: items,
    }, nil
},
```

## âš ï¸ å¸¸è§é”™è¯¯

### 1. å•é€‰å­—æ®µå¼ºè¡Œèšåˆ

```go
// âŒ é”™è¯¯ï¼šå•é€‰å­—æ®µä½¿ç”¨èšåˆè®¡ç®—
Statistics: map[string]interface{}{
    "å•†å“æ€»æ•°": "count(ä»·æ ¼)",      // æ°¸è¿œæ˜¾ç¤º1ï¼Œæ¯«æ— æ„ä¹‰
    "æœ€ä½ä»·æ ¼": "min(ä»·æ ¼)",       // æ°¸è¿œæ˜¯ç”¨æˆ·é€‰çš„å•†å“ä»·æ ¼
    "æœ€é«˜ä»·æ ¼": "max(ä»·æ ¼)",       // æ°¸è¿œæ˜¯ç”¨æˆ·é€‰çš„å•†å“ä»·æ ¼
}

// âœ… æ­£ç¡®ï¼šå•é€‰å­—æ®µåªè¿”å›é™æ€ä¿¡æ¯
Statistics: map[string]interface{}{
    "é…é€æ–¹å¼": "é¡ºä¸°å¿«é€’",
    "ä¿è´¨æœŸ": "12ä¸ªæœˆ",
    "é€€æ¢æ”¿ç­–": "7å¤©æ— ç†ç”±é€€æ¢",
}
```

### 2. å•é€‰ç”¨INæŸ¥è¯¢

```go
// âŒ é”™è¯¯ï¼šå•é€‰å­—æ®µç”¨INæŸ¥è¯¢
if req.IsByFiledValues() {
    db.Where("id in ?", req.GetFiledValues()) // å•é€‰å­—æ®µç”¨INæ•ˆç‡ä½
}

// âœ… æ­£ç¡®ï¼šå•é€‰å­—æ®µç”¨ç­‰å€¼æŸ¥è¯¢
if req.IsByFiledValue() {
    db.Where("id = ?", req.GetFiledValue()).Limit(1) // æ€§èƒ½æœ€ä¼˜
}
```

### 3. ç¼ºå°‘æ³¨é‡Šè¯´æ˜

```go
// âŒ é”™è¯¯ï¼šç¼ºå°‘æ³¨é‡Šè¯´æ˜
"field_name": func(ctx *runner.Context, req *usercall.OnInputFuzzyReq) (*usercall.OnInputFuzzyResp, error) {
    // æ²¡æœ‰è¯´æ˜å­—æ®µç±»å‹å’Œç›®æ ‡
}

// âœ… æ­£ç¡®ï¼šåŒ…å«å®Œæ•´æ³¨é‡Š
"field_name": func(ctx *runner.Context, req *usercall.OnInputFuzzyReq) (*usercall.OnInputFuzzyResp, error) {
    // ã€å½“å‰åœºæ™¯ã€‘field_nameæ˜¯å•é€‰å­—æ®µï¼Œåªè¿”å›é™æ€ä¿¡æ¯ï¼Œä¸åšèšåˆè®¡ç®—
    // ã€ç›®æ ‡å­—æ®µã€‘ä¸º YourRequest.FieldName æä¾›æ•°æ®é€‰æ‹©
}
```

## ğŸ† æœ€ä½³å®è·µæ€»ç»“

1. **ä½¿ç”¨ä¸‰å±‚æŸ¥è¯¢é€»è¾‘**ï¼š`IsByFiledValues()` â†’ `IsByFiledValue()` â†’ æ¨¡ç³ŠæŸ¥è¯¢
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šå•å€¼ç”¨ç­‰å€¼æŸ¥è¯¢ï¼Œå¤šå€¼ç”¨INæŸ¥è¯¢ï¼Œæ¨¡ç³ŠæŸ¥è¯¢åŠ é™åˆ¶
3. **æ³¨é‡Šè§„èŒƒ**ï¼šæ¯ä¸ªå›è°ƒéƒ½è¦è¯´æ˜åœºæ™¯å’Œç›®æ ‡å­—æ®µ
4. **èšåˆåˆ¤æ–­**ï¼šå•é€‰ä¸èšåˆï¼Œå¤šé€‰/Listæ‰èšåˆ
5. **ä¿¡æ¯ç²¾ç®€**ï¼š3-5ä¸ªé‡è¦ä¿¡æ¯å³å¯ï¼Œé¿å…ä¿¡æ¯è¿‡è½½

## âš ï¸ é‡è¦é™·é˜±ï¼šGORMé“¾å¼è°ƒç”¨

### é—®é¢˜ä»£ç ï¼ˆé”™è¯¯ï¼‰
```go
db := ctx.MustGetOrInitDB()

if req.IsByFiledValues() {
    // âŒ é”™è¯¯ï¼šæ²¡æœ‰é‡æ–°èµ‹å€¼ï¼Œæ¡ä»¶ä¸ä¼šç”Ÿæ•ˆ
    db.Where("id in ?", req.GetFiledValues())
} else if req.IsByFiledValue() {
    // âŒ é”™è¯¯ï¼šæ²¡æœ‰é‡æ–°èµ‹å€¼ï¼Œæ¡ä»¶ä¸ä¼šç”Ÿæ•ˆ
    db.Where("id = ?", req.GetFiledValue()).Limit(1)
} else {
    // âŒ é”™è¯¯ï¼šæ²¡æœ‰é‡æ–°èµ‹å€¼ï¼Œæ¡ä»¶ä¸ä¼šç”Ÿæ•ˆ
    db.Where("name LIKE ?", "%"+keyword+"%").Where("status = ?", "æ­£å¸¸").Limit(20)
}

db.Find(&items) // è¿™é‡Œä¼šæŸ¥è¯¢æ‰€æœ‰æ•°æ®ï¼Œå¿½ç•¥ä¸Šé¢çš„æ¡ä»¶ï¼
```

### æ­£ç¡®ä»£ç 
```go
db := ctx.MustGetOrInitDB()

if req.IsByFiledValues() {
    // âœ… æ­£ç¡®ï¼šé‡æ–°èµ‹å€¼ï¼Œæ¡ä»¶ç”Ÿæ•ˆ
    db = db.Where("id in ?", req.GetFiledValues())
} else if req.IsByFiledValue() {
    // âœ… æ­£ç¡®ï¼šé‡æ–°èµ‹å€¼ï¼Œæ¡ä»¶ç”Ÿæ•ˆ
    db = db.Where("id = ?", req.GetFiledValue()).Limit(1)
} else {
    // âœ… æ­£ç¡®ï¼šé‡æ–°èµ‹å€¼ï¼Œæ¡ä»¶ç”Ÿæ•ˆ
    db = db.Where("name LIKE ?", "%"+keyword+"%").Where("status = ?", "æ­£å¸¸").Limit(20)
}

db.Find(&items) // è¿™é‡Œä¼šåº”ç”¨æ‰€æœ‰æ¡ä»¶
```

### ä¸ºä»€ä¹ˆéœ€è¦é‡æ–°èµ‹å€¼ï¼Ÿ

**GORMçš„é“¾å¼è°ƒç”¨ç‰¹æ€§**ï¼š
- æ¯æ¬¡è°ƒç”¨ `Where()`ã€`Limit()` ç­‰æ–¹æ³•éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ `*gorm.DB` å®ä¾‹
- ä¸ä¼šä¿®æ”¹åŸæœ‰çš„ `db` å˜é‡
- å¿…é¡»å°†ç»“æœé‡æ–°èµ‹å€¼ç»™ `db` å˜é‡ï¼Œæ¡ä»¶æ‰ä¼šç”Ÿæ•ˆ

**è®°å¿†å£è¯€**ï¼š`db = db.Where()` è€Œä¸æ˜¯ `db.Where()`

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [OnInputFuzzyèšåˆè®¡ç®—çš„å¸¸è§ç”¨æ³•å’Œè§„èŒƒ](./OnInputFuzzyèšåˆè®¡ç®—çš„å¸¸è§ç”¨æ³•å’Œè§„èŒƒ.mdc)
- [SFTæ•°æ®æ„é€ è§„èŒƒ-æœ€ä½³å®è·µ](./SFTæ•°æ®æ„é€ è§„èŒƒ-æœ€ä½³å®è·µ.mdc)